<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>年末調整情報 提出フォーム</title>
    
    <link rel="icon" href="./favicon.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="./favicon.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 20px auto; padding: 0 20px; background-color: #f4f4f4; }
        h1 { color: #2c3e50; text-align: center; }
        .form-container, .confirm-container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        fieldset {
            border: 1px solid #ddd;
            padding: 20px;
            padding-top: 30px; /* legendとの余白を確保 */
            margin-bottom: 20px;
            border-radius: 5px;
            position: relative;
        }
        
        legend {
            font-weight: bold;
            color: #3498db;
            font-size: 1.2em;
            padding: 0 10px;
            margin-left: 10px;
            width: auto;
            border: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: calc(100% - 20px);
        }

        .form-group, .form-row { margin-bottom: 20px; }
        .form-row { display: flex; gap: 20px; }
        .form-row > div { flex: 1; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #34495e; }
        input[type="text"], input[type="email"], input[type="file"], select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; font-size: inherit; }
        input[readonly] { background-color: #e9e9e9; }
        .radio-group label, .checkbox-group label { display: inline-block; margin-right: 15px; font-weight: normal; }
        .hidden { display: none; }
        .date-select-group { display: flex; gap: 10px; align-items: center; }
        .date-select-group select { flex-grow: 1; }
        .btn-container { text-align: center; margin-top: 30px; }
        button { background-color: #3498db; color: white; padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #2980b9; }
        #confirm-back-btn { background-color: #95a5a6; }
        .btn-remove { background-color: #e74c3c; font-size: 12px; padding: 4px 10px; }
        .btn-remove:hover { background-color: #c0392b; }
        
        #confirm-table { width: 100%; border-collapse: collapse; }
        #confirm-table th, #confirm-table td { border: 1px solid #ddd; padding: 12px; text-align: left; word-break: break-all; }
        #confirm-table th { background-color: #ecf0f1; width: 35%; }
        .yen-input-wrapper { position: relative; }
        .yen-input-wrapper input { padding-right: 2em; text-align: right; }
        .yen-input-wrapper::after { content: '円'; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #555; pointer-events: none; }

        .tooltip-wrapper {
            display: flex;
            align-items: baseline;
            gap: 10px;
        }
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .tooltip-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 20px;
            height: 20px;
            background-color: #bdc3c7;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            user-select: none;
        }
        .tooltip-text {
            visibility: hidden;
            opacity: 0;
            width: 250px;
            background-color: #34495e;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            transition: opacity 0.3s;
            font-size: 0.8em;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #34495e transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text,
        .tooltip-container.show .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .form-group-ssmall input,
        .form-group-ssmall select {
            max-width: 100px;
        }
        .form-group-small .yen-input-wrapper {
            display: block; 
            max-width: 200px;
        }
        .form-group-small input,
        .form-group-small select{
            max-width: 200px;
        }
        .form-group-medium input,
        .form-group-medium select {
            max-width: 400px;
        }
        .form-group-large input,
        .form-group-large select {
            max-width: 500px;
        }

        /* --- ローディング画面と完了画面のスタイル --- */
        #loading, #complete {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        #loading {
            background-color: rgba(255, 255, 255, 0.9);
        }
        #complete {
            background-color: #f1f5f9; /* Tailwindのbg-slate-100 */
        }
        .fly {
            animation: fly 1.5s ease-in-out infinite;
        }
        @keyframes fly {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        .trail span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
            opacity: 0;
            animation: trail 1.5s linear infinite;
        }
        .trail span:nth-child(1) { animation-delay: -0.1s; }
        .trail span:nth-child(2) { animation-delay: -0.2s; }
        .trail span:nth-child(3) { animation-delay: -0.3s; }
        .trail span:nth-child(4) { animation-delay: -0.4s; }
        .trail span:nth-child(5) { animation-delay: -0.5s; }
        @keyframes trail {
            0% { transform: translateX(20px) scale(0.5); opacity: 0; }
            50% { transform: translateX(0) scale(1); opacity: 1; }
            100% { transform: translateX(-80px) scale(0.5); opacity: 0; }
        }
        
        @media (max-width: 600px) {
            body { padding: 0 10px; }
            h1 { font-size: 1.8em; }
            .form-container, .confirm-container { padding: 20px; }
            .form-row { flex-direction: column; gap: 0; }
            .form-row > div { margin-bottom: 20px; }
            .form-row > div:last-child { margin-bottom: 0; }
            #confirm-table th, #confirm-table td, #result-table th, #result-table td { display: block; width: 100%; text-align: left !important; }
            #confirm-table th, #result-table th { border-bottom: none; background-color: transparent; font-size: 0.9em; color: #555; padding-bottom: 3px; }
            #confirm-table td, #result-table td { border-top: none; padding-top: 0; }
            button { width: 100%; padding: 15px; }
            #confirm-back-btn { margin-top: 10px; }
            .date-select-group { flex-wrap: wrap; gap: 2%; }
            .date-select-group select.era { width: 30%; flex-grow: 0; }
            .date-select-group select.year, .date-select-group select.month, .date-select-group select.day { width: 24%; flex-grow: 0; }
        }
    </style>
</head>
<body>

    <h1>年末調整情報 提出フォーム</h1>

    <div id="form-contents" class="form-container">
        <form id="main-form" class="h-adr" novalidate>
            <span class="p-country-name" style="display:none;">Japan</span>

            <fieldset>
                <legend>ご本人情報</legend>
                <div class="form-group form-group-medium"><label>事業者名</label><input type="text" name="company_name" required></div>
                <div class="form-group form-group-medium"><label>メールアドレス</label><input type="email" name="email_address" required></div>
                <div class="form-row">
                    <div><label>姓</label><input type="text" id="name_last" name="last_name" required></div>
                    <div><label>名</label><input type="text" id="name_first" name="first_name" required></div>
                </div>
                <div class="form-row">
                    <div><label>姓フリガナ</label><input type="text" id="kana_last" name="last_name_furigana" pattern="[ァ-ヶー]+" title="全角カタカナで入力してください" required></div>
                    <div><label>名フリガナ</label><input type="text" id="kana_first" name="first_name_furigana" pattern="[ァ-ヶー]+" title="全角カタカナで入力してください" required></div>
                </div>
                <div class="form-group">
                    <label>生年月日</label>
                    <div class="date-select-group" data-prefix="user">
                        <select class="era"><option value="">元号</option></select>
                        <select class="year"><option value="">年</option></select><span>年</span>
                        <select class="month"><option value="">月</option></select><span>月</span>
                        <select class="day"><option value="">日</option></select><span>日</span>
                    </div>
                    <input type="hidden" name="birth_date">
                </div>
                <div class="form-group form-group-small">
				<div class="tooltip-wrapper">
    				<label>郵便番号</label>
    				<div class="tooltip-container">
    					<span class="tooltip-icon">!</span>
    					<div class="tooltip-text">令和7年12月31日時点の住民票住所を記載してください</div>
    				</div>
				</div>
					 <input type="text" name="postal_code" class="p-postal-code" placeholder="例: 1600022 (ハイフンなし)" required>
				</div>
                <div class="form-group form-group-large">
                    <label>住所1（市区町村、番地）</label>
                    <input type="text" id="address1" name="address1" class="p-region p-locality p-street-address" placeholder="例: 東京都新宿区新宿4-3-17" required>
                </div>
                <div class="form-group form-group-large">
                    <label>住所2（建物名、部屋番号など）</label>
                    <input type="text" id="address2" name="address2" placeholder="例: FORECAST新宿SOUTH">
                </div>
                <div class="form-group form-group-medium">
                    <label>世帯主の氏名</label>
                    <input type="text" name="householder_name">
                </div>
                <div class="form-group form-group-ssmall">
                    <label>世帯主の続柄</label>
                    <select name="householder_relationship">
                    	<option value=""></option>
                        <option value="本人">本人</option> <option value="妻">妻</option><option value="夫">夫</option><option value="息子">息子</option><option value="娘">娘</option>
                        <option value="実父">実父</option><option value="実母">実母</option><option value="義父">義父</option>
                        <option value="義母">義母</option><option value="祖父">祖父</option><option value="祖母">祖母</option>
                        <option value="孫">孫</option><option value="兄">兄</option><option value="姉">姉</option>
                        <option value="弟">弟</option><option value="妹">妹</option><option value="叔父">叔父</option>
                        <option value="叔母">叔母</option><option value="甥">甥</option><option value="姪">姪</option><option value="その他">その他</option>
                    </select>
                </div>
            </fieldset>

            <fieldset>
                <legend>年末調整実施確認</legend>
                <div class="form-group">
                    <label>当社で年末調整をおこないますか？</label>
                    <div class="radio-group">
                        <label><input type="radio" name="year_end_adjustment" value="はい" onchange="toggleMainSections(this.value)" checked> はい</label>
                        <label><input type="radio" name="year_end_adjustment" value="いいえ" onchange="toggleMainSections(this.value)"> いいえ</label>
                    </div>
                     <p style="font-size: 0.8em; color: #555; margin-top: 5px;">他社で給与収入がある場合は、原則、確定申告が必要となりますが、収入が多い勤務先で年末調整をおこなうことができます。<br>※給与収入が2,000万円を超える方は、確定申告が必要です。</p>
                </div>
            </fieldset>
            
            <div id="main-sections">
            </div>

            <div id="submit-button-container" class="btn-container">
                <button type="button" onclick="showConfirm()">確認画面へ</button>
            </div>
        </form>
    </div>

    <div id="confirm-contents" class="confirm-container hidden"></div>
    
    <div id="loading" class="hidden">
        <div class="flex flex-col items-center justify-center p-8 rounded-lg">
            <div class="relative w-36 h-36 flex items-center justify-center">
                <div>
                    <img src="./mark-color.png" alt="送信中ロゴ" class="w-24 h-24 fly">
                </div>
                <div class="trail absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-cyan-400" aria-hidden="true">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <p class="mt-4 text-xl font-semibold text-slate-600 animate-pulse">送信しています...</p>
            <p class="mt-2 text-sm text-slate-500">しばらくお待ちください</p>
        </div>
    </div>

    <div id="complete" class="hidden"></div>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://yubinbango.github.io/yubinbango/yubinbango.js" charset="UTF-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.autokana/1.2.2/jquery.autokana.js"></script>
    
    <script>
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwvQJgN_HG3j34Y1drCzF7i9ZDKu4OYnuUafQm1HFz9ngtGBa7sG0jbcDGpGHZm6SBBNg/exec';
        const form = document.getElementById('main-form');
        const formContents = document.getElementById('form-contents');
        const confirmContents = document.getElementById('confirm-contents');
        const loading = document.getElementById('loading');
        const complete = document.getElementById('complete');
        const mainSectionsContainer = document.getElementById('main-sections');
        
        const MAX_DEPENDENTS = 6;

        const warekiData = {
            '令和': { start: 2019, years: new Date().getFullYear() - 2019 + 1 },
            '平成': { start: 1989, years: 31 },
            '昭和': { start: 1926, years: 64 }
        };

        function setupWarekiDateFields(group) {
            const eraSelect = group.querySelector('.era');
            const yearSelect = group.querySelector('.year');
            const monthSelect = group.querySelector('.month');
            const daySelect = group.querySelector('.day');
            Object.keys(warekiData).forEach(era => {eraSelect.options[eraSelect.options.length] = new Option(era, era);});
            for (let i = 1; i <= 12; i++) monthSelect.options[monthSelect.options.length] = new Option(i, i);
            for (let i = 1; i <= 31; i++) daySelect.options[daySelect.options.length] = new Option(i, i);
            eraSelect.addEventListener('change', () => {
                yearSelect.innerHTML = '<option value="">年</option>';
                const era = eraSelect.value;
                if (era && warekiData[era]) {
                    for (let i = 1; i <= warekiData[era].years; i++) {
                        yearSelect.options[yearSelect.options.length] = new Option(i === 1 ? '元' : i, i);
                    }
                }
            });
        }

        function syncAddress(destPrefix, checkbox) {
            const userAddr1 = document.getElementById('address1').value;
            const userAddr2 = document.getElementById('address2').value;
            const destAddr1 = document.getElementById(`${destPrefix}_address1`);
            const destAddr2 = document.getElementById(`${destPrefix}_address2`);
            if (checkbox.checked) {
                destAddr1.value = userAddr1;
                destAddr2.value = userAddr2;
                destAddr1.disabled = true;
                destAddr2.disabled = true;
            } else {
                destAddr1.disabled = false;
                destAddr2.disabled = false;
            }
        }

        function toggleSection(show, sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            section.classList.toggle('hidden', !show);
            section.querySelectorAll('input, select, textarea').forEach(input => {
                if (!section.closest('[disabled]')) {
                    input.disabled = !show;
                }
            });
            if (sectionId === 'dependents-section' && !show) {
                for (let i = 1; i <= MAX_DEPENDENTS; i++) {
                    removeDependentField(i);
                }
                document.getElementById('add-dependent-btn').classList.remove('hidden');
            }
        }

        function toggleMainSections(value) {
            const show = value === 'はい';
            mainSectionsContainer.style.display = show ? 'block' : 'none';
            mainSectionsContainer.querySelectorAll('input, select, button').forEach(input => {
                input.disabled = !show;
            });
            if (!show) {
                document.getElementById('submit-button-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        function addDependentField() {
            const nextDependentGroup = document.querySelector('#dependents-section .hidden[id^="dependent-group-"]');
            if (nextDependentGroup) {
                nextDependentGroup.classList.remove('hidden');
            }
            
            const anyHidden = document.querySelector('#dependents-section .hidden[id^="dependent-group-"]');
            if (!anyHidden) {
                document.getElementById('add-dependent-btn').classList.add('hidden');
            }
        }

        function removeDependentField(dependentNumber) {
            const groupToRemove = document.getElementById(`dependent-group-${dependentNumber}`);
            if (!groupToRemove) return;

            groupToRemove.querySelectorAll('input[type="text"], input[type="hidden"], input[type="file"], select, textarea').forEach(el => el.value = '');
            groupToRemove.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
            groupToRemove.querySelectorAll('input[type="radio"]').forEach(el => {
                const isDefaultNo = el.value === 'なし' && (el.name.includes('severance_pay_existence') || el.name.includes('disability_certificate_existence'));
                el.checked = isDefaultNo;
            });
            
            if (dependentNumber > 1) {
                groupToRemove.classList.add('hidden');
            }
            document.getElementById('add-dependent-btn').classList.remove('hidden');
        }
        
        function formatCurrency(event) {
            const input = event.target;
            let value = input.value.replace(/,/g, '');
            if (value === '' || isNaN(value)) {
                input.value = '';
                return;
            }
            input.value = Number(value).toLocaleString('ja-JP');
        }

        function populateMainSections() {
            let dependentsHtml = '';
            for (let i = 0; i < MAX_DEPENDENTS; i++) {
                dependentsHtml += `
                    <fieldset id="dependent-group-${i + 1}" class="${i > 0 ? 'hidden' : ''}">
                        <legend>
                            <span>扶養親族 ${i + 1}</span>
                            ${i > 0 ? `<button type="button" class="btn-remove" onclick="removeDependentField(${i + 1})">この親族を削除</button>` : ''}
                        </legend>
                        <div class="form-row">
                            <div><label>姓</label><input type="text" id="dependent_${i + 1}_name_last" name="dependent_${i + 1}_last_name"></div>
                            <div><label>名</label><input type="text" id="dependent_${i + 1}_name_first" name="dependent_${i + 1}_first_name"></div>
                        </div>
                        <div class="form-row">
                            <div><label>姓フリガナ</label><input type="text" id="dependent_${i + 1}_kana_last" name="dependent_${i + 1}_last_name_furigana" pattern="[ァ-ヶー]+" title="全角カタカナで入力してください"></div>
                            <div><label>名フリガナ</label><input type="text" id="dependent_${i + 1}_kana_first" name="dependent_${i + 1}_first_name_furigana" pattern="[ァ-ヶー]+" title="全角カタカナで入力してください"></div>
                        </div>
                        <div class="form-group form-group-ssmall">
                            <label>続柄</label>
                            <select name="dependent_${i + 1}_relationship">
                                <option value=""></option>
                                <option value="息子">息子</option><option value="娘">娘</option><option value="実父">実父</option><option value="実母">実母</option><option value="義父">義父</option>
                                <option value="義母">義母</option><option value="祖父">祖父</option><option value="祖母">祖母</option>
                                <option value="孫">孫</option><option value="兄">兄</option><option value="姉">姉</option>
                                <option value="弟">弟</option><option value="妹">妹</option><option value="叔父">叔父</option>
                                <option value="叔母">叔母</option><option value="甥">甥</option><option value="姪">姪</option>
                            </select>
                        </div>
                        <div class="form-group"><label>生年月日</label><div class="date-select-group" data-prefix="dependent_${i + 1}"><select class="era"><option value="">元号</option></select><select class="year"><option value="">年</option></select><span>年</span><select class="month"><option value="">月</option></select><span>月</span><select class="day"><option value="">日</option></select><span>日</span></div><input type="hidden" name="dependent_${i + 1}_birth_date"></div>
                        <div class="form-group checkbox-group"><label><input type="checkbox" onchange="syncAddress('dependent_${i + 1}', this)"> 本人と住所が同じ</label></div>
                        <div class="form-group form-group-large"><label>住所1</label><input type="text" id="dependent_${i + 1}_address1" name="dependent_${i + 1}_address1"></div>
                        <div class="form-group form-group-large"><label>住所2</label><input type="text" id="dependent_${i + 1}_address2" name="dependent_${i + 1}_address2"></div>
                        <div class="form-group form-group-small"><div class="tooltip-wrapper"><label>収入金額</label>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">!</span>
                                <div class="tooltip-text">令和7年(2025年)中の収入を記載してください。<br>給与収入の場合は総支給額から非課税交通費を除いた金額です。</div>
                            </div>
                        </div>
                            <div class="yen-input-wrapper"><input type="text" name="dependent_${i + 1}_income_amount" class="currency-input" inputmode="numeric"></div></div>
                        <div class="form-group"><label>退職手当有無</label><div class="radio-group"><label><input type="radio" name="dependent_${i + 1}_severance_pay_existence" value="あり">あり</label><label><input type="radio" name="dependent_${i + 1}_severance_pay_existence" value="なし" checked>なし</label></div></div>
                        <div class="form-group form-group-small"><label>退職手当等金額</label><div class="yen-input-wrapper"><input type="text" name="dependent_${i + 1}_severance_pay_amount" class="currency-input" inputmode="numeric"></div></div>
                        <div class="form-group"><label>障害者手帳交付有無</label><div class="radio-group"><label><input type="radio" name="dependent_${i + 1}_disability_certificate_existence" value="あり" onchange="toggleSection(this.value === 'あり', 'dependent-${i + 1}-disability-file-group')"> あり</label><label><input type="radio" name="dependent_${i + 1}_disability_certificate_existence" value="なし" onchange="toggleSection(this.value === 'あり', 'dependent-${i + 1}-disability-file-group')" checked> なし</label></div></div>
                        <div id="dependent-${i + 1}-disability-file-group" class="form-group hidden">
                            <label>障害者手帳</label>
                            <input type="file" name="dependent_${i + 1}_disability_certificate_file" multiple>
                            <label style="margin-top:15px;">備考</label>
                            <textarea name="dependent_${i + 1}_disability_certificate_remarks" rows="3" placeholder="添付が難しい場合はこちらに「交付年月日、等級」をご記入ください"></textarea>
                        </div>
                    </fieldset>
                `;
            }

            mainSectionsContainer.innerHTML = `
                <fieldset>
					<legend>令和7年(2025年)に入社された方</legend>
					<div class="form-group">
						<label>令和7年(2025年)中に退職した勤務先はありますか？</label>
						<div class="radio-group">
							<label><input type="radio" name="previous_job" value="あり" onchange="toggleSection(this.value === 'あり', 'gensen-group')"> あり</label>
							<label><input type="radio" name="previous_job" value="なし" onchange="toggleSection(this.value === 'あり', 'gensen-group')" checked> なし</label>
						</div>
					</div>
					<div id="gensen-group" class="form-group hidden"><label>前職の源泉徴収票</label><input type="file" name="previous_job_file" multiple>
						<p style="font-size: 0.8em; color: #555; margin-top: 5px;">※令和7年(2025年)中に退職した勤務先が複数ある場合は、すべての勤務先の源泉徴収票をアップロードしてください。</p></div>
				</fieldset>
                <fieldset>
                    <legend>その他収入について</legend>
                    <div class="form-group">
                            <label>給与収入以外の収入がある場合は「あり」を選択してください。</label>
                            <p style="font-size: 0.8em; color: #555; margin-top: 5px;">※例：公的年金、不動産収入、原稿料など<br> ※国や自治体から支給される手当や給付金は収入には含みません。</p>
                        <div class="radio-group">
                            <label><input type="radio" name="other_income_existence" value="あり" onchange="toggleSection(this.value === 'あり', 'other-income-group')"> あり</label>
                            <label><input type="radio" name="other_income_existence" value="なし" onchange="toggleSection(this.value === 'あり', 'other-income-group')" checked>なし</label>
                        </div>
                    </div>
                    <div id="other-income-group" class="form-group form-group-small hidden"><div class="tooltip-wrapper">
                        <label>その他収入金額</label>
                        <div class="tooltip-container">
                                <span class="tooltip-icon">!</span>
                                <div class="tooltip-text">令和7年1月1日～12月31日の間の収入を記載してください。</div>
                            </div>
                        </div>
                        <div class="yen-input-wrapper"><input type="text" name="other_income_amount" class="currency-input" inputmode="numeric"></div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>住民税</legend>
                    <div class="form-group form-group-small"><label>住民税徴収方法</label>
                    	<p style="font-size: 0.8em; color: #555; margin-top: 5px;">※原則、特別徴収を選択してください。</p></div>
                    	<div class="radio-group">
                            <label><input type="radio" name="resident_tax" value="特別徴収" checked> 特別徴収</label>
                            <label><input type="radio" name="resident_tax" value="普通徴収"> 普通徴収</label>
                        </div>
                </fieldset>
                <fieldset>
                    <legend>配偶者情報</legend>
                    <div class="form-group"><label>配偶者有無</label><div class="radio-group"><label><input type="radio" name="spouse_existence" value="あり" onchange="toggleSection(this.value === 'あり', 'spouse-group')"> あり</label><label><input type="radio" name="spouse_existence" value="なし" onchange="toggleSection(this.value === 'あり', 'spouse-group')" checked> なし</label></div></div>
                    <div id="spouse-group" class="hidden">
                        <div class="form-row">
                            <div><label>姓</label><input type="text" id="spouse_name_last" name="spouse_last_name"></div>
                            <div><label>名</label><input type="text" id="spouse_name_first" name="spouse_first_name"></div>
                        </div>
                        <div class="form-row">
                            <div><label>姓フリガナ</label><input type="text" id="spouse_kana_last" name="spouse_last_name_furigana" pattern="[ァ-ヶー]+" title="全角カタカナで入力してください"></div>
                            <div><label>名フリガナ</label><input type="text" id="spouse_kana_first" name="spouse_first_name_furigana" pattern="[ァ-ヶー]+" title="全角カタカナで入力してください"></div>
                        </div>
                        <div class="form-group"><label>生年月日</label><div class="date-select-group" data-prefix="spouse"><select class="era"><option value="">元号</option></select><select class="year"><option value="">年</option></select><span>年</span><select class="month"><option value="">月</option></select><span>月</span><select class="day"><option value="">日</option></select><span>日</span></div><input type="hidden" name="spouse_birth_date"></div>
                        <div class="form-group checkbox-group"><label><input type="checkbox" onchange="syncAddress('spouse', this)"> 本人と住所が同じ</label></div>
                        <div class="form-group form-group-large"><label>住所1</label><input type="text" id="spouse_address1" name="spouse_address1"></div>
                        <div class="form-group form-group-large"><label>住所2</label><input type="text" id="spouse_address2" name="spouse_address2"></div>
                        <div class="form-group form-group-small"><div class="tooltip-wrapper"><label>収入金額</label>
                        	<div class="tooltip-container">
                                <span class="tooltip-icon">!</span>
                                <div class="tooltip-text">令和7年(2025年)中の収入を記載してください。<br>給与収入の場合は総支給額から非課税交通費を除いた金額です。</div>
                            </div>
                        </div>
                        	<div class="yen-input-wrapper"><input type="text" name="spouse_income_amount" class="currency-input" inputmode="numeric"></div></div>
                        <div class="form-group"><label>退職手当有無</label><div class="radio-group"><label><input type="radio" name="spouse_severance_pay_existence" value="あり">あり</label><label><input type="radio" name="spouse_severance_pay_existence" value="なし" checked>なし</label></div></div>
                        <div class="form-group form-group-small"><label>退職手当等金額</label><div class="yen-input-wrapper"><input type="text" name="spouse_severance_pay_amount" class="currency-input" inputmode="numeric"></div></div>
                        <div class="form-group"><label>障害者手帳交付有無</label><div class="radio-group"><label><input type="radio" name="spouse_disability_certificate_existence" value="あり" onchange="toggleSection(this.value === 'あり', 'spouse-disability-file-group')"> あり</label><label><input type="radio" name="spouse_disability_certificate_existence" value="なし" onchange="toggleSection(this.value === 'あり', 'spouse-disability-file-group')" checked> なし</label></div></div>
                        <div id="spouse-disability-file-group" class="form-group hidden">
                            <label>障害者手帳</label>
                            <input type="file" name="spouse_disability_certificate_file" multiple>
                            <label style="margin-top:15px;">備考</label>
                            <textarea name="spouse_disability_certificate_remarks" rows="3" placeholder="添付が難しい場合はこちらに「交付年月日、等級」をご記入ください"></textarea>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>扶養親族情報</legend>
                    <div class="form-group"><label>扶養親族有無</label><div class="radio-group"><label><input type="radio" name="dependents_existence" value="あり" onchange="toggleSection(this.value === 'あり', 'dependents-section')"> あり</label><label><input type="radio" name="dependents_existence" value="なし" onchange="toggleSection(this.value === 'あり', 'dependents-section')" checked> なし</label></div></div>
                </fieldset>
                <div id="dependents-section" class="hidden">
                    ${dependentsHtml}
                    <div class="btn-container"><button type="button" id="add-dependent-btn" onclick="addDependentField()">＋ 扶養親族を追加</button></div>
                </div>
                <fieldset>
                    <legend>本人該当項目</legend>
                    <div class="form-group"><label>障害者手帳交付有無</label><div class="radio-group"><label><input type="radio" name="user_disability_certificate_existence" value="あり" onchange="toggleSection(this.value === 'あり', 'user-disability-file-group')"> あり</label><label><input type="radio" name="user_disability_certificate_existence" value="なし" onchange="toggleSection(this.value === 'あり', 'user-disability-file-group')" checked> なし</label></div></div>
                    <div id="user-disability-file-group" class="form-group hidden">
                        <label>障害者手帳</label>
                        <input type="file" name="user_disability_certificate_file" multiple>
                        <label style="margin-top:15px;">備考</label>
                        <textarea name="user_disability_certificate_remarks" rows="3" placeholder="添付が難しい場合はこちらに「交付年月日、等級」をご記入ください"></textarea>
                    </div>
                    <div class="form-group"><div class="tooltip-wrapper"><label>寡婦該当確認</label>
                    	<div class="tooltip-container">
                        	<span class="tooltip-icon">!</span>
                            <div class="tooltip-text">ひとり親に該当しない女性で、下記のいずれかに該当する場合は該当を選択してください。<br>・夫と離婚後に再婚しておらず、子以外の扶養親族がいる場合<br>・夫と死別後に再婚していない場合</div>
                        </div></div>
                    	<div class="radio-group"><label><input type="radio" name="widow_status" value="該当">該当</label><label><input type="radio" name="widow_status" value="非該当" checked>非該当</label></div></div>
                    <div class="form-group"><div class="tooltip-wrapper"><label>ひとり親該当確認</label>
                    	<div class="tooltip-container">
                        	<span class="tooltip-icon">!</span>
                            <div class="tooltip-text">現在、事実婚を含む婚姻されていない方で、生計を一にする子がいる場合は該当を選択してください。</div>
                        </div></div>
                    	<div class="radio-group"><label><input type="radio" name="single_parent_status" value="該当">該当</label><label><input type="radio" name="single_parent_status" value="非該当" checked>非該当</label></div></div>
                    <div class="form-group"><div class="tooltip-wrapper"><label>勤労学生該当確認</label>
                    	<div class="tooltip-container">
                        	<span class="tooltip-icon">!</span>
                            <div class="tooltip-text">学生の方で令和7年(2025年)中の収入金額が130万円以下の場合は該当を選択し、学生証をアップロードしてください。</div>
                        </div></div>
                    	<div class="radio-group"><label><input type="radio" name="working_student_status" value="該当" onchange="toggleSection(this.value === '該当', 'student-card-group')">該当</label><label><input type="radio" name="working_student_status" value="非該当" onchange="toggleSection(this.value === '該当', 'student-card-group')" checked>非該当</label></div></div>
                    <div id="student-card-group" class="form-group hidden"><label>勤労学生_学生証</label><input type="file" name="student_card_file"></div>
                    <div class="form-group"><div class="tooltip-wrapper"><label>災害者該当確認</label>
                    	<div class="tooltip-container">
                        	<span class="tooltip-icon">!</span>
                            <div class="tooltip-text">災害によって住宅や家財に損害を受けた方で、下記3つを満たす場合は該当を選択してください。<br>①災害のあった年分の所得金額が1,000万円以下<br>②災害によって受けた損害額が住宅または家財の1/2の価値<br>③雑損控除の適用をうけない</div>
                        </div></div>
                    	<div class="radio-group"><label><input type="radio" name="disaster_status" value="該当">該当</label><label><input type="radio" name="disaster_status" value="非該当" checked>非該当</label></div></div>
                </fieldset>
                <fieldset>
                    <legend>各種控除</legend>
                    <div class="form-group"><label>生命保険料控除有無</label><div class="radio-group"><label><input type="radio" name="life_insurance_deduction" value="あり" onchange="toggleSection(this.value === 'あり', 'life-insurance-group')">あり</label><label><input type="radio" name="life_insurance_deduction" value="なし" onchange="toggleSection(this.value === 'あり', 'life-insurance-group')" checked>なし</label></div></div>
                    <div id="life-insurance-group" class="form-group hidden"><label>生命保険料_控除証明書</label><input type="file" name="life_insurance_file" multiple>
                    	<p style="font-size: 0.8em; color: #555; margin-top: 5px;">※複数ある場合は、すべてアップロードしてください。</p></div>
                    <div class="form-group"><label>地震保険料控除有無</label><div class="radio-group"><label><input type="radio" name="earthquake_insurance_deduction" value="あり" onchange="toggleSection(this.value === 'あり', 'earthquake-insurance-group')">あり</label><label><input type="radio" name="earthquake_insurance_deduction" value="なし" onchange="toggleSection(this.value === 'あり', 'earthquake-insurance-group')" checked>なし</label></div></div>
                    <div id="earthquake-insurance-group" class="form-group hidden"><label>地震保険料_控除証明書</label><input type="file" name="earthquake_insurance_file" multiple>
                    	<p style="font-size: 0.8em; color: #555; margin-top: 5px;">※複数ある場合は、すべてアップロードしてください。</p></div>
                    <div class="form-group"><div class="tooltip-wrapper"><label>社会保険料控除有無</label>
                    	<div class="tooltip-container">
                                <span class="tooltip-icon">!</span>
                                <div class="tooltip-text">ご自身でお支払いされた国民健康保険料、国民年金保険料が対象です。<br>給与から控除されている健康保険料や厚生年金は含みません。</div>
                            </div>
                        </div>
                    	<div class="radio-group"><label><input type="radio" name="social_insurance_deduction" value="あり" onchange="toggleSection(this.value === 'あり', 'social-insurance-group')">あり</label><label><input type="radio" name="social_insurance_deduction" value="なし" onchange="toggleSection(this.value === 'あり', 'social-insurance-group')" checked>なし</label></div></div>
                    <div id="social-insurance-group" class="hidden" style="border: 1px solid #eee; padding: 15px; border-radius: 5px;">
                        <div class="form-group">
                            <label style="font-size: 1.1em; color: #333;">国民健康保険料</label>
                            <p style="font-size: 0.8em; color: #555; margin-top: 5px;">年間支払額を入力するか、控除証明書をアップロードしてください。</p>
                            <div class="form-group form-group-medium" style="margin-top: 15px;">
                                <label>国民健康保険料を支払うことになっている人の氏名</label>
                                <input type="text" name="national_health_insurance_payer_name">
                            </div>
                            <div class="form-group form-group-small" style="margin-top: 15px;">
                                <label>年間支払額</label>
                                <div class="yen-input-wrapper">
                                    <input type="text" name="national_health_insurance_amount" class="currency-input" inputmode="numeric">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>控除証明書</label>
                                <input type="file" name="national_health_insurance_file" multiple>
                            </div>
                        </div>
                        <hr style="border: none; border-top: 1px dashed #ddd; margin: 25px 0;">
                        <div class="form-group">
                            <label style="font-size: 1.1em; color: #333;">国民年金保険料</label>
                            <p style="font-size: 0.8em; color: #555; margin-top: 5px;">控除証明書をアップロードしてください。</p>
                            <div class="form-group" style="margin-top: 15px;">
                                <label>控除証明書</label>
                                <input type="file" name="national_pension_insurance_file" multiple>
                            </div>
                        </div>
                    </div>
                    <div class="form-group"> <div class="tooltip-wrapper"><label>小規模企業共済掛金等控除有無</label>
                    	<div class="tooltip-container">
                                <span class="tooltip-icon">!</span>
                                <div class="tooltip-text">・中小企業基盤整備機構の共済契約の掛金<br>・企業型年金加入者掛金<br>・個人型年金加入者掛金<br>・心身障害者扶養共済制度に関する契約の掛金</div>
                            </div>
                        </div>
                    	<div class="radio-group"><label><input type="radio" name="small_business_deduction" value="あり" onchange="toggleSection(this.value === 'あり', 'small-business-group')">あり</label><label><input type="radio" name="small_business_deduction" value="なし" onchange="toggleSection(this.value === 'あり', 'small-business-group')" checked>なし</label></div></div>
                    <div id="small-business-group" class="form-group hidden"><label>小規模企業共済掛金等_控除証明書</label><input type="file" name="small_business_file" multiple>
                    	<p style="font-size: 0.8em; color: #555; margin-top: 5px;">※複数ある場合は、すべてアップロードしてください。</p></div>
                    <div class="form-group"><label>住宅ローン控除有無</label><div class="radio-group"><label><input type="radio" name="housing_loan_deduction" value="あり" onchange="toggleSection(this.value === 'あり', 'housing-loan-group')">あり</label><label><input type="radio" name="housing_loan_deduction" value="なし" onchange="toggleSection(this.value === 'あり', 'housing-loan-group')" checked>なし</label></div></div>
                    <div id="housing-loan-group" class="form-group hidden"><label>住宅ローン_申告書・証明書</label><input type="file" name="housing_loan_file" multiple>
                    	<p style="font-size: 0.8em; color: #555; margin-top: 5px;">※令和7年分の「給与所得者の(特定増改築等)住宅借入金等特別控除申告書」と「住宅取得資金に係る借入金の年末残高等証明書」をアップロードしてください。</p>
                    	<p style="font-size: 0.8em; color: #555; margin-top: 5px;">※「住宅取得資金に係る借入金の年末残高等証明書」が複数ある場合はすべてアップロードしてください。</p></div>
                </fieldset>
            `;
        }

        function formatPostalCode(inputName) {
            const inputElement = form.querySelector(`[name="${inputName}"]`);
            if (inputElement && inputElement.value) {
                let value = inputElement.value.replace(/-/g, '');
                if (value.length === 7 && /^\d+$/.test(value)) {
                    inputElement.value = value.slice(0, 3) + '-' + value.slice(3);
                }
            }
        }
        
        function showConfirm() {
            formatPostalCode('postal_code');
            
            document.querySelectorAll('.date-select-group').forEach(group => {
                const prefix = group.dataset.prefix;
                const era = group.querySelector('.era').value;
                const year = group.querySelector('.year option:checked').textContent;
                const month = group.querySelector('.month').value;
                const day = group.querySelector('.day').value;
                const hiddenInputName = prefix === 'user' ? 'birth_date' : `${prefix}_birth_date`;
                const hiddenInput = form.querySelector(`input[name="${hiddenInputName}"]`);
                if (era && year && month && day && hiddenInput) {
                    hiddenInput.value = `${era}${year}年${month}月${day}日`;
                } else if (hiddenInput) {
                    hiddenInput.value = '';
                }
            });

            form.querySelectorAll('.currency-input').forEach(input => {
                input.value = input.value.replace(/,/g, '');
            });

            if (!form.checkValidity()) {
                form.reportValidity();
                form.querySelectorAll('.currency-input').forEach(input => {
                    if(input.value) input.value = Number(input.value).toLocaleString('ja-JP');
                });
                return;
            }

            let confirmHtml = `<h2>入力内容の確認</h2><p>以下の内容で送信します。よろしいですか？</p><table id="confirm-table"></table><div class="btn-container"><button id="confirm-back-btn" type="button" onclick="goBack()">修正する</button><button id="submit-btn" type="button" onclick="submitForm()">送信する</button></div>`;
            confirmContents.innerHTML = confirmHtml;

            const table = document.getElementById('confirm-table');
            const formData = new FormData(form);

            const getDisplayValue = (name) => {
                const input = form.querySelector(`[name="${name}"]`);
                if (!input) return null;
                if (input.type === 'file') {
                    return input.files.length > 0 ? Array.from(input.files).map(f => f.name).join(', ') : null;
                }
                let value = input.disabled ? input.value : formData.get(name);
                if (value === null || value === undefined || value === '') return null;
                if (input.classList.contains('currency-input')) {
                    return Number(String(value).replace(/,/g, '')).toLocaleString('ja-JP') + ' 円';
                }
                return value;
            };

            const addRow = (label, value) => {
                const row = table.insertRow();
                row.insertCell().outerHTML = `<th>${label}</th>`;
                row.insertCell().textContent = value;
            };

            const processFields = (fieldList) => {
                for (const [name, label] of fieldList) {
                    if (name.startsWith('spouse_') && name !== 'spouse_existence') {
                        if (formData.get('spouse_existence') !== 'あり') continue;
                    }
                    if (name === 'spouse_disability_certificate_file' || name === 'spouse_disability_certificate_remarks') {
                        if(formData.get('spouse_disability_certificate_existence') !== 'あり') continue;
                    }
                    if (name === 'previous_job_file') {
                        if (formData.get('previous_job') !== 'あり') continue;
                    }
                    if (name === 'user_disability_certificate_file' || name === 'user_disability_certificate_remarks') {
                        if (formData.get('user_disability_certificate_existence') !== 'あり') continue;
                    }
                    if (name === 'student_card_file') {
                        if (formData.get('working_student_status') !== '該当') continue;
                    }
                    const deductionFile = ['life_insurance_file', 'earthquake_insurance_file', 'small_business_file', 'housing_loan_file'];
                    if (deductionFile.includes(name)) {
                        const radioName = name.replace('_file', '_deduction');
                        if (formData.get(radioName) !== 'あり') continue;
                    }
                    
                    const socialInsuranceFields = ['national_health_insurance_payer_name', 'national_health_insurance_amount', 'national_health_insurance_file', 'national_pension_insurance_file'];
                    if (socialInsuranceFields.includes(name)) {
                        if (formData.get('social_insurance_deduction') !== 'あり') continue;
                    }

                    const value = getDisplayValue(name);
                    if (value !== null) {
                        addRow(label, value);
                    }
                }
            };
            
            const preDependentsFields = [
                ['company_name', '会社名'], ['email_address', 'メールアドレス'], ['last_name', '姓'], ['first_name', '名'],
                ['last_name_furigana', '姓フリガナ'], ['first_name_furigana', '名フリガナ'], ['birth_date', '生年月日'],
                ['postal_code', '郵便番号'], ['address1', '住所1'], ['address2', '住所2'], 
                ['householder_name', '世帯主の氏名'], ['householder_relationship', '世帯主の続柄'],
                ['year_end_adjustment', '年末調整実施可否'],
                ['previous_job', '前職有無'], ['previous_job_file', '前職源泉徴収票'], 
                ['other_income_existence', 'その他収入有無'], ['other_income_amount', 'その他収入金額'],
                ['resident_tax', '住民税徴収方法'],
                ['spouse_existence', '配偶者有無'], ['spouse_last_name', '配偶者 姓'], ['spouse_first_name', '配偶者 名'],
                ['spouse_last_name_furigana', '配偶者 姓フリガナ'], ['spouse_first_name_furigana', '配偶者 名フリガナ'],
                ['spouse_birth_date', '配偶者 生年月日'], ['spouse_address1', '配偶者 住所1'], ['spouse_address2', '配偶者 住所2'],
                ['spouse_income_amount', '配偶者 収入金額'], ['spouse_severance_pay_existence', '配偶者 退職手当有無'],
                ['spouse_severance_pay_amount', '配偶者 退職手当等金額'], 
                ['spouse_disability_certificate_existence', '配偶者 障害者手帳交付有無'],
                ['spouse_disability_certificate_file', '配偶者 障害者手帳'],
                ['spouse_disability_certificate_remarks', '配偶者 障害者手帳(備考)'],
                ['dependents_existence', '扶養親族有無'],
            ];

            const postDependentsFields = [
                ['user_disability_certificate_existence', '本人 障害者手帳交付有無'],
                ['user_disability_certificate_file', '本人 障害者手帳'],
                ['user_disability_certificate_remarks', '本人 障害者手帳(備考)'],
                ['widow_status', '寡婦該当確認'], ['single_parent_status', 'ひとり親該当確認'],
                ['working_student_status', '勤労学生該当確認'], ['student_card_file', '勤労学生_学生証'],
                ['disaster_status', '災害者該当確認'],
                ['life_insurance_deduction', '生命保険料控除有無'], ['life_insurance_file', '生命保険料_控除証明書'],
                ['earthquake_insurance_deduction', '地震保険料控除有無'], ['earthquake_insurance_file', '地震保険料_控除証明書'],
                ['social_insurance_deduction', '社会保険料控除有無'],
                ['national_health_insurance_payer_name', '国民健康保険料 支払対象者氏名'],
                ['national_health_insurance_amount', '国民健康保険料 年間支払額'],
                ['national_health_insurance_file', '国民健康保険料 控除証明書'],
                ['national_pension_insurance_file', '国民年金保険料 控除証明書'],
                ['small_business_deduction', '小規模企業共済掛金等控除有無'], ['small_business_file', '小規模企業共済掛金等_控除証明書'],
                ['housing_loan_deduction', '住宅ローン控除有無'], ['housing_loan_file', '住宅ローン_申告書・証明書']
            ];

            processFields(preDependentsFields);

            if (formData.get('dependents_existence') === 'あり') {
                for (let i = 1; i <= MAX_DEPENDENTS; i++) {
                    const isDependentEntered = formData.get(`dependent_${i}_last_name`) || formData.get(`dependent_${i}_first_name`);
                    if (isDependentEntered) {
                        const dependentFields = [
                            [`dependent_${i}_last_name`, `【扶養親族${i}】姓`], [`dependent_${i}_first_name`, `【扶養親族${i}】名`],
                            [`dependent_${i}_last_name_furigana`, `【扶養親族${i}】姓フリガナ`], [`dependent_${i}_first_name_furigana`, `【扶養親族${i}】名フリガナ`],
                            [`dependent_${i}_relationship`, `【扶養親族${i}】続柄`], [`dependent_${i}_birth_date`, `【扶養親族${i}】生年月日`],
                            [`dependent_${i}_address1`, `【扶養親族${i}】住所1`], [`dependent_${i}_address2`, `【扶養親族${i}】住所2`],
                            [`dependent_${i}_income_amount`, `【扶養親族${i}】収入金額`], [`dependent_${i}_severance_pay_existence`, `【扶養親族${i}】退職手当有無`],
                            [`dependent_${i}_severance_pay_amount`, `【扶養親族${i}】退職手当等金額`],
                            [`dependent_${i}_disability_certificate_existence`, `【扶養親族${i}】障害者手帳交付有無`],
                            [`dependent_${i}_disability_certificate_file`, `【扶養親族${i}】障害者手帳`],
                            [`dependent_${i}_disability_certificate_remarks`, `【扶養親族${i}】障害者手帳(備考)`]
                        ];
                        dependentFields.forEach(([name, label]) => {
                             if (name.endsWith('_file') || name.endsWith('_remarks')) {
                                 if (formData.get(`dependent_${i}_disability_certificate_existence`) !== 'あり') return;
                             }
                            const value = getDisplayValue(name);
                            if (value !== null) {
                                addRow(label, value);
                            }
                        });
                    }
                }
            }
            
            processFields(postDependentsFields);

            formContents.classList.add('hidden');
            confirmContents.classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function goBack() {
            form.querySelectorAll('.currency-input').forEach(input => {
                if(input.value) input.value = Number(input.value.replace(/,/g, '')).toLocaleString('ja-JP');
            });
            confirmContents.classList.add('hidden');
            formContents.classList.remove('hidden');
        }

        async function submitForm() {
            confirmContents.classList.add('hidden');
            loading.classList.remove('hidden');
            
            form.querySelectorAll('.currency-input').forEach(input => {
                input.value = input.value.replace(/,/g, '');
            });

            const fileToBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({
                    name: file.name,
                    mimeType: file.type,
                    base64: reader.result.split(',')[1]
                });
                reader.onerror = error => reject(error);
            });

            const formData = new FormData(form);
            const dataObject = {};
            for (const [key, value] of formData.entries()) {
                if (!form.querySelector(`[name="${key}"]`)?.disabled) {
                    dataObject[key] = value;
                }
            }
            
            const fileInputs = form.querySelectorAll('input[type="file"]');
            const filePromises = [];

            fileInputs.forEach(input => {
                if (input.files.length > 0 && !input.disabled) {
                    const fieldName = input.name;
                    dataObject[fieldName] = [];
                    for (const file of input.files) {
                        filePromises.push(
                            fileToBase64(file).then(fileData => {
                                dataObject[fieldName].push(fileData);
                            })
                        );
                    }
                }
            });
            
            await Promise.all(filePromises);

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify({postData: dataObject})
                });
                
                const result = await response.json();
                
                loading.classList.add('hidden');
                if (result.result === 'success') {
                    complete.innerHTML = `
                    <div class="w-full max-w-2xl bg-white rounded-lg shadow-lg p-8">
                        <div class="text-center">
                            <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                            <h2 class="text-2xl font-bold text-slate-800">ご提出ありがとうございます</h2>
                            <p class="text-slate-600 mt-2">年末調整情報の送信が完了しました。</p>
                            <div class="bg-slate-50 p-3 rounded-md mt-4 text-sm text-slate-700">
                                <p><span class="font-semibold">回答ID:</span> ${result.submissionId}</p>
                                <p class="mt-1 text-xs text-slate-500">このIDは回答内容の確認に必要ですので、大切に保管してください。</p>
                            </div>
                        </div>
        
                        <hr class="my-8 border-slate-200">
        
                        <div>
                            <div class="mb-6 text-center">
                                <img src="./logo-color-2.jpg" alt="スタートアップ税理士法人 ロゴ" class="h-12 mx-auto">
                            </div>
                            <p class="text-slate-600 mb-4">
                                ご提出いただいた情報は、<span class="font-semibold text-blue-600">「スタートアップ税理士法人」</span>が年末調整手続きを代行するために利用します。
                            </p>
                            <ul class="space-y-3 text-slate-600">
                                <li class="flex items-start">
                                    <i class="fas fa-user-check text-blue-500 mt-1 mr-3 fa-fw"></i>
                                    <span>税務の専門家が、提出内容を責任をもって確認いたします。</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-file-signature text-blue-500 mt-1 mr-3 fa-fw"></i>
                                    <span>内容確認後、法令に基づき行政機関への適切な手続きを行います。</span>
                                </li>
                            </ul>
                            <div class="mt-6 p-4 bg-slate-50 rounded-lg flex items-start">
                                <i class="fas fa-shield-halved text-slate-500 mt-1 mr-3 fa-fw"></i>
                                <div>
                                    <h4 class="font-semibold text-slate-700">個人情報の取り扱いについて</h4>
                                    <p class="text-sm text-slate-600 mt-1">
                                        お預かりした個人情報は、個人情報保護法に則り厳重に管理し、年末調整の目的以外では一切使用いたしません。
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    complete.classList.remove('hidden');
                } else {
                    alert(`送信に失敗しました: ${result.message}`);
                    goBack();
                }
            } catch (error) {
                loading.classList.add('hidden');
                alert(`送信中にエラーが発生しました: ${error}`);
                goBack();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                const params = new URLSearchParams(window.location.search);
                const companyName = params.get('company');
                if (companyName) {
                    const companyInput = form.querySelector('[name="company_name"]');
                    if (companyInput) {
                        companyInput.value = companyName;
                        companyInput.readOnly = true;
                    }
                }
            } catch(e) { console.error("URLパラメータ処理エラー:", e); }

            populateMainSections();
            
            document.querySelectorAll('.date-select-group').forEach(setupWarekiDateFields);
            toggleMainSections(form.querySelector('input[name="year_end_adjustment"]:checked').value);
            
            $(function() {
                const options = { katakana: true };
                $.fn.autoKana('#name_last', '#kana_last', options);
                $.fn.autoKana('#name_first', '#kana_first', options);
                $.fn.autoKana('#spouse_name_last', '#spouse_kana_last', options);
                $.fn.autoKana('#spouse_name_first', '#spouse_kana_first', options);
                for (let i = 1; i <= MAX_DEPENDENTS; i++) {
                    $.fn.autoKana(`#dependent_${i}_name_last`, `#dependent_${i}_kana_last`, options);
                    $.fn.autoKana(`#dependent_${i}_name_first`, `#dependent_${i}_kana_first`, options);
                }
            });

            form.addEventListener('input', (event) => {
                if (event.target.classList.contains('currency-input')) {
                    formatCurrency(event);
                }
            });

            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('tooltip-icon')) {
                    const parent = e.target.parentElement;
                    const wasActive = parent.classList.contains('show');
                    document.querySelectorAll('.tooltip-container.show').forEach(c => c.classList.remove('show'));
                    if (!wasActive) {
                        parent.classList.add('show');
                    }
                } 
                else if (!e.target.closest('.tooltip-container')) {
                    document.querySelectorAll('.tooltip-container.show').forEach(c => c.classList.remove('show'));
                }
            });
        });
    </script>
</body>
</html>